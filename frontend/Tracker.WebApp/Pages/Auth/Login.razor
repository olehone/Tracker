@page "/login"
@layout EmptyLayout

@inject IAuthApi AuthApi
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider 

@using Microsoft.AspNetCore.Components.Authorization
@using Tracker.Services
@using Tracker.Services.ApiClients
@using Tracker.Domain.Entities.Commands
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations


<MudContainer MaxWidth="MaxWidth.Medium" Class="d-flex justify-center align-center" Style="height:100vh;">
	<MudGrid Justify="Justify.Center">
		<MudItem xs="12" sm="7">
			<MudPaper Class="pa-4" Elevation="5">
				<MudForm @ref="form" @bind-IsValid=@success @bind-Errors=@errors>
					<MudTextField T="string"
								  @bind-Value="Email"
								  Label="Email"
								  Required="true"
								  RequiredError="Email is required!"
								  Validation=@(new EmailAddressAttribute() {ErrorMessage = "The email address is invalid"}) />
					<MudTextField T="string"
								  Label="Password"
								  @bind-Value="Password"
								  HelperText="Choose a strong password" @ref="pwField1"
								  InputType="InputType.Password"
								  Validation=@(new Func<string, IEnumerable<string>>(PasswordStrength)) Required="true"
								  RequiredError="Password is required!" />
					<MudTextField T="string"
								  Label="Password"
								  @bind-Value="RepeatPassword"
								  HelperText="Repeat the password"
								  InputType="InputType.Password"
								  Validation=@(new Func<string, string>(PasswordMatch)) />
				</MudForm>
			</MudPaper>
			<MudPaper Class="pa-4 mt-4" Elevation="5">
				<MudButton Variant="Variant.Filled" Color="Color.Primary" DropShadow="false" OnClick=@HandleLogin>Login</MudButton>
				<MudButton Variant="Variant.Filled" Color="Color.Secondary" DropShadow="false" OnClick="@(() => form.ResetAsync())" Class="mx-2">Reset</MudButton>
			</MudPaper>
		</MudItem>
	</MudGrid>
</MudContainer>
@code {
	bool success;
	string[] errors = { };
	MudTextField<string> pwField1;
	MudForm form;

	private string Email { get; set; }
	private string Password { get; set; }
	private string RepeatPassword { get; set; }

	private IEnumerable<string> PasswordStrength(string pw)
	{
		if (string.IsNullOrWhiteSpace(pw))
		{
			yield return "Password is required!";
			yield break;
		}
		if (pw.Length < 8)
			yield return "Password must be at least of length 8";
		// if (!Regex.IsMatch(pw, @"[A-Z]"))
		//     yield return "Password must contain at least one capital letter";
		// if (!Regex.IsMatch(pw, @"[a-z]"))
		//     yield return "Password must contain at least one lowercase letter";
		// if (!Regex.IsMatch(pw, @"[0-9]"))
		//     yield return "Password must contain at least one digit";
	}

	private string PasswordMatch(string arg)
	{
		if (Password != arg)
			return "Passwords don't match";
		return null;
	}


	private async Task HandleLogin()
	{
		await form.Validate();
		if (!success || Password != RepeatPassword)
		{
			return;
		}


		try
		{
			var res = await AuthApi.LoginAsync(new LoginUserCommand()
			{
				Email = Email,
				Password = Password
			});
			if (res !=null && res.AccessToken != null)
			{
				Navigation.NavigateTo("/");
				// ((CustomAuthStateProvider)AuthenticationStateProvider).MarkUserAsAuthenticated(res.AccessToken);
			}

		}
		catch (Exception ex)
		{
			Console.WriteLine(ex.Message);
		}

	}
}